<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>Reaktions-Flip</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,.05);
      --panel2: rgba(15,23,42,.62);
      --line: rgba(148,163,184,.20);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#6366f1;
      --ok:#22c55e;
      --danger:#ef4444;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --r: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(99,102,241,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.16), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(239,68,68,.12), transparent 55%),
        var(--bg);
    }
    .wrap{
      min-height:100%;
      padding: max(16px, env(safe-area-inset-top)) 16px max(16px, env(safe-area-inset-bottom));
      display:flex; align-items:center; justify-content:center;
    }
    .app{
      width:min(620px, 100%);
      border:1px solid var(--line);
      border-radius: calc(var(--r) + 8px);
      box-shadow: var(--shadow);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
    }
    header{
      padding:18px 18px 14px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      border-bottom:1px solid var(--line);
    }
    .brand h1{margin:0; font-size:20px; letter-spacing:.2px}
    .brand p{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35}
    .topBtns{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}

    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform: translateY(1px)}
    .primary{
      background: linear-gradient(180deg, rgba(99,102,241,.95), rgba(99,102,241,.75));
      border-color: rgba(99,102,241,.55);
    }
    .danger{
      background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(239,68,68,.7));
      border-color: rgba(239,68,68,.5);
    }
    .ghost{background: rgba(255,255,255,.03)}

    .screen{display:none}
    .screen.active{display:block}

    .home{
      padding: 18px;
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap:14px;
    }
    @media (max-width: 560px){
      .home{grid-template-columns: 1fr}
    }
    .card{
      border:1px solid var(--line);
      background: var(--panel2);
      border-radius: calc(var(--r) + 6px);
      padding:14px;
    }
    .card h2{margin:0 0 8px; font-size:16px}
    .card p{margin:0; color:var(--muted); font-size:13px; line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{height:12px}

    .chipRow{display:flex; gap:10px; flex-wrap:wrap}
    .chip{
      padding:9px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:900;
      font-size:12.5px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      color: var(--text);
      border-color: rgba(99,102,241,.55);
      background: rgba(99,102,241,.20);
    }

    .big{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      font-size:14px;
    }

    .stats{
      padding: 14px 18px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:10px;
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    @media (max-width: 560px){
      .stats{grid-template-columns: 1fr 1fr}
    }
    .stat{
      border:1px solid var(--line);
      background: rgba(17,24,39,.52);
      border-radius: var(--r);
      padding:10px 12px;
      display:flex; flex-direction:column; gap:6px;
    }
    .stat span{color:var(--muted); font-size:12px}
    .stat b{font-size:18px}

    .game{padding: 12px 18px 14px}
    .board{
      aspect-ratio:1/1;
      width:100%;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius: calc(var(--r) + 6px);
      background: var(--panel2);
    }
    .tile{
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      transition: transform .08s ease, background .14s ease, box-shadow .14s ease, border-color .14s ease;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      overflow:hidden;
    }
    .tile:active{transform: scale(.98)}
    .tile.active{
      background:
        radial-gradient(120px 120px at 40% 30%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(180deg, rgba(99,102,241,.95), rgba(99,102,241,.65));
      border-color: rgba(99,102,241,.65);
      box-shadow: 0 14px 28px rgba(99,102,241,.22);
    }
    .tile.bad{
      background: linear-gradient(180deg, rgba(239,68,68,.7), rgba(239,68,68,.22));
      border-color: rgba(239,68,68,.55);
      box-shadow: 0 14px 26px rgba(239,68,68,.18);
    }

    .bar{
      padding: 0 18px 18px;
      color: var(--muted);
      font-size: 12.5px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius: 999px;
      display:flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--text)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      border:1px solid var(--line);
      padding:2px 6px;
      border-radius:8px;
      color:var(--muted);
    }

    dialog{
      border:none; border-radius: 18px; padding:0;
      width:min(520px, calc(100% - 30px));
      background: rgba(17,24,39,.92);
      color:var(--text);
      box-shadow: var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.45)}
    .modal{
      padding:16px;
      border:1px solid var(--line);
      border-radius: 18px;
    }
    .modal h3{margin:0 0 8px; font-size:18px}
    .modal p{margin:0 0 14px; color:var(--muted); line-height:1.35; white-space:pre-line}
    .modal .row{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    .list{
      margin: 10px 0 14px;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
    }
    .item{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
      font-size:13px;
    }
    .item:last-child{border-bottom:none}
    .toggle{display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:8px 0; color:var(--muted); font-size:13px}
    input[type="checkbox"]{transform: scale(1.2)}
    input[type="range"]{width: 180px}

    a.linkBtn{
      display:inline-flex; align-items:center; justify-content:center;
      text-decoration:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      font-size:13px;
    }
    a.linkBtn.primary{
      background: linear-gradient(180deg, rgba(99,102,241,.95), rgba(99,102,241,.75));
      border-color: rgba(99,102,241,.55);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">
      <header>
        <div class="brand">
          <h1>Reaktions-Flip</h1>
          <p>Mehr Spielspaß • App Feeling • Musik • Support</p>
        </div>
        <div class="topBtns">
          <button id="btnHome" class="ghost">Home</button>
          <button id="btnSettings" class="ghost">Einstellungen</button>
          <button id="btnScores" class="ghost">Highscores</button>
        </div>
      </header>

      <!-- HOME -->
      <section id="screenHome" class="screen active">
        <div class="home">
          <div class="card">
            <h2>Start</h2>
            <p>Wähle Modus & Schwierigkeit und starte dann das Spiel.</p>

            <div class="spacer"></div>
            <p><b>Modus</b></p>
            <div class="chipRow" role="group" aria-label="Modus">
              <div id="chipEndless" class="chip active">Endlos</div>
              <div id="chipTime" class="chip">30s</div>
            </div>

            <div class="spacer"></div>
            <p><b>Schwierigkeit</b></p>
            <div class="chipRow" role="group" aria-label="Schwierigkeit">
              <div id="chipEasy" class="chip">Easy</div>
              <div id="chipNormal" class="chip active">Normal</div>
              <div id="chipHard" class="chip">Hard</div>
            </div>

            <div class="spacer"></div>
            <button id="btnPlay" class="primary big">Spielen</button>

            <div class="spacer"></div>
            <div class="row">
              <button id="btnHow" class="ghost">Regeln</button>
              <button id="btnResetAll" class="danger">Daten löschen</button>
            </div>
          </div>

          <div class="card">
            <h2>Support</h2>
            <p>Wenn dir das Spiel gefällt, kannst du mich unterstützen ❤️</p>
            <div class="spacer"></div>
            <a id="supportLink" class="linkBtn primary" href="#" target="_blank" rel="noopener">Support / Spenden</a>
            <div class="spacer"></div>

            <h2>Power-Ups</h2>
            <p>Im Spiel laden sich Power-Ups durch Treffer auf.</p>
            <div class="spacer"></div>
            <p style="color:var(--muted);font-size:12.5px;">
              • Shield: rettet dich 1× vor einem Fehler (wenn aktiviert)<br>
              • Freeze: 5 Sekunden langsamer
            </p>
          </div>
        </div>
      </section>

      <!-- GAME -->
      <section id="screenGame" class="screen">
        <section class="stats">
          <div class="stat"><span>Score</span><b id="score">0</b></div>
          <div class="stat"><span>Combo</span><b id="combo">0</b></div>
          <div class="stat"><span>Leben</span><b id="lives">3</b></div>
          <div class="stat"><span id="statRightLabel">Zeitlimit</span><b id="statRightValue">1200 ms</b></div>
        </section>

        <div class="game">
          <div id="board" class="board" aria-label="Spielfeld (3x3)"></div>
        </div>

        <div class="bar">
          <div class="pill">Modus: <b id="pillMode">Endlos</b></div>
          <div class="pill">Diff: <b id="pillDiff">Normal</b></div>
          <div class="pill">Best: <b id="best">0</b></div>
          <div class="pill" id="pillTimeLeft" style="display:none;">Rest: <b id="timeLeft">30.0s</b></div>

          <div style="width:100%; display:flex; gap:10px; flex-wrap:wrap;">
            <button id="btnShield" class="ghost" style="flex:1; min-width: 150px;">Shield</button>
            <button id="btnFreeze" class="ghost" style="flex:1; min-width: 150px;">Freeze</button>
            <button id="btnPause" class="ghost" style="flex:1; min-width: 150px;">Pause</button>
            <button id="btnRestart" class="danger" style="flex:1; min-width: 150px;">Neu</button>
          </div>

          <div style="width:100%; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <span class="kbd" id="hint">Tippe die leuchtende Kachel.</span>
            <span class="kbd" id="powerHint">Power-Ups laden sich auf.</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- RULES -->
  <dialog id="dlgHow">
    <div class="modal">
      <h3>Regeln</h3>
      <p>
• Tippe die leuchtende Kachel, bevor die Zeit abläuft.
• Falscher Tap oder zu langsam: Leben verlieren (Shield kann einmal retten).
• Endlos: solange du Leben hast.
• 30s: so viele Treffer wie möglich in 30 Sekunden.
• Power-Ups: laden sich durch Treffer auf.
      </p>
      <div class="row">
        <button id="howClose" class="primary">OK</button>
      </div>
    </div>
  </dialog>

  <!-- GAME OVER -->
  <dialog id="dlgOver">
    <div class="modal">
      <h3 id="overTitle">Game Over</h3>
      <p id="overText"></p>
      <div class="row">
        <button id="overHome" class="ghost">Home</button>
        <button id="overAgain" class="primary">Nochmal</button>
      </div>
    </div>
  </dialog>

  <!-- SETTINGS -->
  <dialog id="dlgSettings">
    <div class="modal">
      <h3>Einstellungen</h3>
      <p>iPhone: Audio läuft erst nach einer User-Aktion (z. B. „Spielen“).</p>

      <div class="toggle">
        <input id="chkSound" type="checkbox" />
        <label for="chkSound">Sound (Effekte)</label>
      </div>

      <div class="toggle">
        <input id="chkMusic" type="checkbox" />
        <label for="chkMusic">Hintergrundmusik</label>
      </div>

      <div class="toggle" style="gap:12px;">
        <label for="rngMusic" style="min-width:140px;">Musik-Lautstärke</label>
        <input id="rngMusic" type="range" min="0" max="100" value="35" />
        <span id="rngMusicLabel">35%</span>
      </div>

      <div class="toggle">
        <input id="chkVibe" type="checkbox" />
        <label for="chkVibe">Vibration</label>
      </div>

      <div class="row">
        <button id="settingsClose" class="primary">OK</button>
      </div>
    </div>
  </dialog>

  <!-- HIGHSCORES -->
  <dialog id="dlgScores">
    <div class="modal">
      <h3>Highscores (Top 10)</h3>
      <p id="scoresSubtitle">Pro Modus werden Scores lokal gespeichert.</p>
      <div class="list" id="scoreList"></div>
      <div class="row">
        <button id="scoresReset" class="danger">Zurücksetzen</button>
        <button id="scoresClose" class="primary">OK</button>
      </div>
    </div>
  </dialog>

<script>
(() => {
  // =======================
  // MONEY: set your link
  // =======================
  const SUPPORT_URL = "https://example.com"; // <-- hier PayPal.me / Ko-fi / BuyMeACoffee eintragen

  // =======================
  // DOM
  // =======================
  const screenHome = document.getElementById('screenHome');
  const screenGame = document.getElementById('screenGame');

  const btnHome = document.getElementById('btnHome');
  const btnSettings = document.getElementById('btnSettings');
  const btnScores = document.getElementById('btnScores');

  const chipEndless = document.getElementById('chipEndless');
  const chipTime = document.getElementById('chipTime');
  const chipEasy = document.getElementById('chipEasy');
  const chipNormal = document.getElementById('chipNormal');
  const chipHard = document.getElementById('chipHard');

  const btnPlay = document.getElementById('btnPlay');
  const btnHow = document.getElementById('btnHow');
  const btnResetAll = document.getElementById('btnResetAll');
  const supportLink = document.getElementById('supportLink');

  const board = document.getElementById('board');

  const elScore = document.getElementById('score');
  const elCombo = document.getElementById('combo');
  const elLives = document.getElementById('lives');
  const elBest = document.getElementById('best');

  const pillMode = document.getElementById('pillMode');
  const pillDiff = document.getElementById('pillDiff');

  const statRightLabel = document.getElementById('statRightLabel');
  const statRightValue = document.getElementById('statRightValue');

  const pillTimeLeft = document.getElementById('pillTimeLeft');
  const timeLeftEl = document.getElementById('timeLeft');

  const hint = document.getElementById('hint');
  const powerHint = document.getElementById('powerHint');

  const btnShield = document.getElementById('btnShield');
  const btnFreeze = document.getElementById('btnFreeze');
  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');

  // dialogs
  const dlgHow = document.getElementById('dlgHow');
  const howClose = document.getElementById('howClose');

  const dlgOver = document.getElementById('dlgOver');
  const overTitle = document.getElementById('overTitle');
  const overText = document.getElementById('overText');
  const overHome = document.getElementById('overHome');
  const overAgain = document.getElementById('overAgain');

  const dlgSettings = document.getElementById('dlgSettings');
  const chkSound = document.getElementById('chkSound');
  const chkMusic = document.getElementById('chkMusic');
  const rngMusic = document.getElementById('rngMusic');
  const rngMusicLabel = document.getElementById('rngMusicLabel');
  const chkVibe = document.getElementById('chkVibe');
  const settingsClose = document.getElementById('settingsClose');

  const dlgScores = document.getElementById('dlgScores');
  const scoreList = document.getElementById('scoreList');
  const scoresClose = document.getElementById('scoresClose');
  const scoresReset = document.getElementById('scoresReset');
  const scoresSubtitle = document.getElementById('scoresSubtitle');

  // =======================
  // Storage helpers
  // =======================
  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch{
      return fallback;
    }
  }
  function saveJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  // keys
  const SETTINGS_KEY = 'rf_settings_v2';
  const BEST_KEY = 'rf_best_v3';
  const SCORES_ENDLESS = 'rf_top10_endless_v1';
  const SCORES_TIME = 'rf_top10_time_v1';

  // settings
  const defaultSettings = { sound:true, music:true, musicVol:35, vibe:true };
  const settings = Object.assign({}, defaultSettings, loadJSON(SETTINGS_KEY, defaultSettings));

  chkSound.checked = !!settings.sound;
  chkMusic.checked = !!settings.music;
  chkVibe.checked = !!settings.vibe;
  rngMusic.value = String(settings.musicVol ?? 35);
  rngMusicLabel.textContent = `${rngMusic.value}%`;

  // highscores
  let best = Number(localStorage.getItem(BEST_KEY) || 0);
  elBest.textContent = String(best);

  let topEndless = loadJSON(SCORES_ENDLESS, []);
  let topTime = loadJSON(SCORES_TIME, []);
  if(!Array.isArray(topEndless)) topEndless = [];
  if(!Array.isArray(topTime)) topTime = [];

  // =======================
  // Game State
  // =======================
  const GRID = 9;
  const TIME_MODE_SECONDS = 30;

  let mode = "endless"; // "endless" | "time"
  let diff = "normal";  // "easy" | "normal" | "hard"

  let running = false;
  let paused = false;

  let score = 0;
  let combo = 0;
  let lives = 3;

  let active = 0;
  let tiles = [];

  let timerRound = null;
  let timerMode = null;
  let timeLeft = TIME_MODE_SECONDS;

  // power-ups
  let shieldCharge = 0;
  let shieldArmed = false;
  let freezeCharge = 0;
  let freezeActiveUntil = 0;

  // =======================
  // Audio (SFX + Music)
  // =======================
  let audioCtx = null;
  let sfxGain = null;
  let bgmGain = null;
  let bgmTimer = null;
  let bgmStep = 0;

  function ensureAudio(){
    if(!settings.sound && !settings.music) return;
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
      audioCtx.resume().catch(()=>{});
    }
    if(!sfxGain){
      sfxGain = audioCtx.createGain();
      sfxGain.gain.value = 0.18;
      sfxGain.connect(audioCtx.destination);
    }
    if(!bgmGain){
      bgmGain = audioCtx.createGain();
      bgmGain.gain.value = 0.0;
      bgmGain.connect(audioCtx.destination);
    }
  }

  function beep(freq, ms, gain=0.12, type="sine"){
    if(!settings.sound) return;
    ensureAudio();
    if(!audioCtx || !sfxGain) return;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;

    g.gain.value = 0.0001;
    g.gain.exponentialRampToValueAtTime(gain, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + ms/1000);

    o.connect(g);
    g.connect(sfxGain);
    o.start();
    o.stop(audioCtx.currentTime + ms/1000 + 0.02);
  }

  const sfx = {
    hit(){ beep(880, 80, 0.12, "sine"); },
    miss(){ beep(220, 120, 0.13, "sine"); },
    start(){ beep(660, 70, 0.10); setTimeout(()=>beep(990, 70, 0.10), 85); },
    over(){ beep(330, 140, 0.10); setTimeout(()=>beep(220, 170, 0.10), 160); },
    power(){ beep(740, 90, 0.10, "triangle"); },
  };

  function vibe(ms){
    if(!settings.vibe) return;
    if(navigator.vibrate) navigator.vibrate(ms);
  }

  function setMusicVolume(pct){
    settings.musicVol = pct;
    saveJSON(SETTINGS_KEY, settings);
    rngMusicLabel.textContent = `${pct}%`;
    ensureAudio();
    if(bgmGain){
      bgmGain.gain.value = (settings.music ? pct : 0) / 100 * 0.22;
    }
  }

  function playTone(freq, ms){
    if(!settings.music) return;
    ensureAudio();
    if(!audioCtx || !bgmGain) return;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "triangle";
    o.frequency.value = freq;

    g.gain.value = 0.0001;
    g.gain.exponentialRampToValueAtTime(0.18, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + ms/1000);

    o.connect(g);
    g.connect(bgmGain);
    o.start();
    o.stop(audioCtx.currentTime + ms/1000 + 0.02);
  }

  function startBgm(){
    if(!settings.music) return;
    ensureAudio();
    setMusicVolume(Number(settings.musicVol ?? 35));
    if(bgmTimer) return;

    const scale = {
      C:  [261.63, 329.63, 392.00, 523.25],
      Am: [220.00, 261.63, 329.63, 440.00],
      F:  [174.61, 220.00, 261.63, 349.23],
      G:  [196.00, 246.94, 293.66, 392.00],
    };
    const chords = [scale.C, scale.Am, scale.F, scale.G];
    bgmStep = 0;

    bgmTimer = setInterval(() => {
      if(!running || paused || !settings.music) return;
      const chord = chords[Math.floor(bgmStep / 16) % chords.length];
      const note = chord[bgmStep % chord.length];
      playTone(note, 110);
      bgmStep++;
    }, 125);
  }

  function stopBgm(){
    if(bgmTimer){
      clearInterval(bgmTimer);
      bgmTimer = null;
    }
    if(bgmGain) bgmGain.gain.value = 0.0;
  }

  // =======================
  // Difficulty & timing
  // =======================
  function baseTime(){
    if(diff === "easy") return 1350;
    if(diff === "hard") return 1050;
    return 1200;
  }
  function minTime(){
    if(diff === "easy") return 520;
    if(diff === "hard") return 380;
    return 450;
  }
  function speedFactor(){
    if(diff === "easy") return 22;
    if(diff === "hard") return 34;
    return 28;
  }
  function roundTimeMs(){
    let ms = Math.max(minTime(), baseTime() - (score * speedFactor()));
    if(Date.now() < freezeActiveUntil){
      ms = Math.min(baseTime(), Math.round(ms * 1.35));
    }
    return ms;
  }

  // =======================
  // UI helpers
  // =======================
  function setActiveScreen(which){
    screenHome.classList.toggle('active', which === 'home');
    screenGame.classList.toggle('active', which === 'game');
  }
  function modeLabel(){ return mode === "time" ? "30s" : "Endlos"; }
  function diffLabel(){ return diff === "easy" ? "Easy" : (diff === "hard" ? "Hard" : "Normal"); }

  function setChipActive(group, value){
    const map = {
      mode: { endless: chipEndless, time: chipTime },
      diff: { easy: chipEasy, normal: chipNormal, hard: chipHard }
    };
    Object.values(map[group]).forEach(el => el.classList.remove('active'));
    map[group][value].classList.add('active');
  }

  function renderStats(){
    elScore.textContent = String(score);
    elCombo.textContent = String(combo);
    elLives.textContent = String(lives);

    pillMode.textContent = modeLabel();
    pillDiff.textContent = diffLabel();

    if(mode === "time"){
      statRightLabel.textContent = "Restzeit";
      statRightValue.textContent = `${timeLeft.toFixed(1)} s`;
      pillTimeLeft.style.display = "inline-flex";
      timeLeftEl.textContent = `${timeLeft.toFixed(1)}s`;
    } else {
      statRightLabel.textContent = "Zeitlimit";
      statRightValue.textContent = `${roundTimeMs()} ms`;
      pillTimeLeft.style.display = "none";
    }

    const shieldReady = shieldCharge >= 100;
    const freezeReady = freezeCharge >= 100;
    btnShield.textContent = shieldReady ? (shieldArmed ? "Shield: ARMED ✅" : "Shield: bereit") : `Shield: ${Math.floor(shieldCharge)}%`;
    btnFreeze.textContent = freezeReady ? "Freeze: aktivieren" : `Freeze: ${Math.floor(freezeCharge)}%`;
    powerHint.textContent = (Date.now() < freezeActiveUntil) ? "Freeze aktiv: Zeit ist langsamer." : "Power-Ups laden sich auf.";
  }

  // =======================
  // Board
  // =======================
  function buildBoard(){
    board.innerHTML = '';
    tiles = [];
    for(let i=0;i<GRID;i++){
      const t = document.createElement('button');
      t.className = 'tile';
      t.setAttribute('aria-label', `Kachel ${i+1}`);
      t.addEventListener('click', () => onTileTap(i));
      board.appendChild(t);
      tiles.push(t);
    }
  }
  function setActiveTile(index){
    tiles.forEach((t,i) => t.classList.toggle('active', running && !paused && i === index));
    active = index;
  }
  function pickNewActive(){
    let next = active;
    while(next === active){
      next = Math.floor(Math.random() * GRID);
    }
    setActiveTile(next);
  }
  function flashBad(index){
    tiles[index].classList.add('bad');
    setTimeout(() => tiles[index].classList.remove('bad'), 160);
  }

  // =======================
  // Scores
  // =======================
  function maybeUpdateBest(sc){
    if(sc > best){
      best = sc;
      localStorage.setItem(BEST_KEY, String(best));
      elBest.textContent = String(best);
    }
  }
  function addToTop10(sc){
    const entry = { score: sc, diff, ts: Date.now() };
    if(mode === "time"){
      topTime.push(entry);
      topTime.sort((a,b)=>b.score - a.score);
      topTime = topTime.slice(0,10);
      saveJSON(SCORES_TIME, topTime);
    } else {
      topEndless.push(entry);
      topEndless.sort((a,b)=>b.score - a.score);
      topEndless = topEndless.slice(0,10);
      saveJSON(SCORES_ENDLESS, topEndless);
    }
  }

  // =======================
  // Game flow
  // =======================
  function scheduleRoundTimeout(){
    clearTimeout(timerRound);
    timerRound = setTimeout(() => {
      if(!running || paused) return;
      miss("Zu langsam!");
    }, roundTimeMs());
  }

  function startModeTimerIfNeeded(){
    clearInterval(timerMode);
    if(mode !== "time") return;
    timeLeft = TIME_MODE_SECONDS;
    timerMode = setInterval(() => {
      if(!running || paused) return;
      timeLeft = Math.max(0, timeLeft - 0.1);
      renderStats();
      if(timeLeft <= 0) finishTimeMode();
    }, 100);
  }

  function addChargesOnHit(){
    const shieldGain = diff === "hard" ? 10 : (diff === "easy" ? 14 : 12);
    const freezeGain = diff === "hard" ? 9  : (diff === "easy" ? 13 : 11);
    shieldCharge = Math.min(100, shieldCharge + shieldGain);
    freezeCharge = Math.min(100, freezeCharge + freezeGain);
  }

  function hit(){
    score += 1;
    combo += 1;
    addChargesOnHit();
    maybeUpdateBest(score);
    sfx.hit(); vibe(16);
    pickNewActive();
    scheduleRoundTimeout();
    renderStats();
  }

  function consumeShield(reason){
    if(shieldArmed && shieldCharge >= 100){
      shieldCharge = 0;
      shieldArmed = false;
      combo = 0;
      hint.textContent = `Shield hat dich gerettet (${reason})`;
      sfx.power(); vibe(30);
      pickNewActive();
      scheduleRoundTimeout();
      renderStats();
      return true;
    }
    return false;
  }

  function miss(reason){
    if(consumeShield(reason)) return;

    combo = 0;
    lives -= 1;
    sfx.miss(); vibe(70);

    if(lives <= 0){
      gameOver(reason);
      return;
    }
    hint.textContent = reason;
    pickNewActive();
    scheduleRoundTimeout();
    renderStats();
  }

  function onTileTap(index){
    ensureAudio();
    if(settings.music) startBgm();
    if(!running || paused) return;

    if(index === active){
      hint.textContent = "Nice!";
      hit();
    } else {
      flashBad(index);
      miss("Falsche Kachel!");
    }
  }

  function startGame(){
    running = true;
    paused = false;

    score = 0; combo = 0; lives = 3;
    shieldCharge = 0; shieldArmed = false;
    freezeCharge = 0; freezeActiveUntil = 0;

    hint.textContent = "Tippe die leuchtende Kachel.";
    buildBoard();
    pickNewActive();

    setActiveScreen('game');
    renderStats();
    scheduleRoundTimeout();
    startModeTimerIfNeeded();

    sfx.start(); vibe(25);
    if(settings.music) startBgm();
  }

  function pauseToggle(){
    if(!running) return;
    paused = !paused;

    if(paused){
      clearTimeout(timerRound);
      hint.textContent = "Pausiert.";
      tiles.forEach(t => t.classList.remove('active'));
      btnPause.textContent = "Weiter";
    } else {
      hint.textContent = "Weiter!";
      setActiveTile(active);
      scheduleRoundTimeout();
      btnPause.textContent = "Pause";
    }
    renderStats();
  }

  function restart(){
    clearTimeout(timerRound);
    clearInterval(timerMode);
    startGame();
  }

  function finishTimeMode(){
    running = false;
    paused = false;
    clearTimeout(timerRound);
    clearInterval(timerMode);
    tiles.forEach(t => t.classList.remove('active'));

    addToTop10(score);
    maybeUpdateBest(score);

    overTitle.textContent = "Zeit um!";
    overText.textContent = `Dein Score: ${score}\nModus: 30s • Diff: ${diffLabel()}\nBest: ${best}`;
    dlgOver.showModal();

    sfx.over(); vibe(200);
  }

  function gameOver(reason){
    running = false;
    paused = false;
    clearTimeout(timerRound);
    clearInterval(timerMode);
    tiles.forEach(t => t.classList.remove('active'));

    addToTop10(score);
    maybeUpdateBest(score);

    overTitle.textContent = "Game Over";
    overText.textContent = `${reason}\nDein Score: ${score}\nModus: ${modeLabel()} • Diff: ${diffLabel()}\nBest: ${best}`;
    dlgOver.showModal();

    sfx.over(); vibe(220);
  }

  // power actions
  function toggleShield(){
    ensureAudio();
    if(shieldCharge < 100){
      hint.textContent = "Shield ist noch nicht bereit.";
      return;
    }
    shieldArmed = !shieldArmed;
    hint.textContent = shieldArmed ? "Shield ARMED: der nächste Fehler ist gratis." : "Shield deaktiviert.";
    sfx.power(); vibe(25);
    renderStats();
  }

  function activateFreeze(){
    ensureAudio();
    if(freezeCharge < 100){
      hint.textContent = "Freeze ist noch nicht bereit.";
      return;
    }
    freezeCharge = 0;
    freezeActiveUntil = Date.now() + 5000;
    hint.textContent = "Freeze aktiv: Zeit ist langsamer!";
    sfx.power(); vibe(35);
    if(running && !paused) scheduleRoundTimeout();
    renderStats();
  }

  // highscores dialog
  function renderScoreList(){
    const list = (mode === "time") ? topTime : topEndless;
    scoresSubtitle.textContent = `Modus: ${modeLabel()} • Top 10 (Diff wird mitgespeichert)`;
    if(!list.length){
      scoreList.innerHTML = `<div class="item"><span>—</span><span>Keine Einträge</span></div>`;
      return;
    }
    const fmt = (ts) => {
      try{
        return new Date(ts).toLocaleString('de-DE', { dateStyle:'short', timeStyle:'short' });
      }catch{
        return '';
      }
    };
    scoreList.innerHTML = list.map((e, idx) => {
      const d = e.diff === "easy" ? "Easy" : (e.diff === "hard" ? "Hard" : "Normal");
      return `<div class="item">
        <span>#${idx+1} • <b>${e.score}</b> • ${d}</span>
        <span style="color:var(--muted)">${fmt(e.ts)}</span>
      </div>`;
    }).join('');
  }

  // selections
  function setMode(newMode){ mode = newMode; setChipActive('mode', mode); }
  function setDiff(newDiff){ diff = newDiff; setChipActive('diff', diff); }

  // reset all
  function resetAllData(){
    if(!confirm("Wirklich ALLE Daten löschen? (Scores, Best, Settings)")) return;
    localStorage.removeItem(SETTINGS_KEY);
    localStorage.removeItem(BEST_KEY);
    localStorage.removeItem(SCORES_ENDLESS);
    localStorage.removeItem(SCORES_TIME);
    location.reload();
  }

  // support link
  if(SUPPORT_URL && SUPPORT_URL.startsWith("http")){
    supportLink.href = SUPPORT_URL;
  } else {
    supportLink.href = "#";
    supportLink.style.opacity = "0.55";
    supportLink.addEventListener('click', (e) => {
      e.preventDefault();
      alert("Trage oben im Code bei SUPPORT_URL deinen Spenden-Link ein (PayPal.me, Ko-fi, …).");
    });
  }

  // top buttons
  btnHome.addEventListener('click', () => setActiveScreen('home'));
  btnSettings.addEventListener('click', () => dlgSettings.showModal());
  settingsClose.addEventListener('click', () => dlgSettings.close());

  btnScores.addEventListener('click', () => { renderScoreList(); dlgScores.showModal(); });
  scoresClose.addEventListener('click', () => dlgScores.close());
  scoresReset.addEventListener('click', () => {
    const key = (mode === "time") ? SCORES_TIME : SCORES_ENDLESS;
    if(confirm(`Highscores für ${modeLabel()} wirklich löschen?`)){
      if(mode === "time") topTime = [];
      else topEndless = [];
      saveJSON(key, []);
      renderScoreList();
    }
  });

  // home
  btnHow.addEventListener('click', () => dlgHow.showModal());
  howClose.addEventListener('click', () => dlgHow.close());
  btnResetAll.addEventListener('click', resetAllData);

  chipEndless.addEventListener('click', () => setMode("endless"));
  chipTime.addEventListener('click', () => setMode("time"));
  chipEasy.addEventListener('click', () => setDiff("easy"));
  chipNormal.addEventListener('click', () => setDiff("normal"));
  chipHard.addEventListener('click', () => setDiff("hard"));

  btnPlay.addEventListener('click', () => { ensureAudio(); startGame(); });

  // game buttons
  btnPause.addEventListener('click', pauseToggle);
  btnRestart.addEventListener('click', restart);
  btnShield.addEventListener('click', toggleShield);
  btnFreeze.addEventListener('click', activateFreeze);

  // settings controls
  chkSound.addEventListener('change', () => {
    settings.sound = chkSound.checked;
    saveJSON(SETTINGS_KEY, settings);
    ensureAudio();
  });

  chkMusic.addEventListener('change', () => {
    settings.music = chkMusic.checked;
    saveJSON(SETTINGS_KEY, settings);
    ensureAudio();
    if(settings.music){
      startBgm();
      setMusicVolume(Number(settings.musicVol ?? 35));
    } else {
      stopBgm();
    }
  });

  rngMusic.addEventListener('input', () => setMusicVolume(Number(rngMusic.value)));

  chkVibe.addEventListener('change', () => {
    settings.vibe = chkVibe.checked;
    saveJSON(SETTINGS_KEY, settings);
  });

  // game over dialog
  overHome.addEventListener('click', () => { dlgOver.close(); setActiveScreen('home'); });
  overAgain.addEventListener('click', () => { dlgOver.close(); startGame(); });

  // init
  setChipActive('mode', mode);
  setChipActive('diff', diff);
  renderStats();
  setActiveScreen('home');

  // Service Worker
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
})();
</script>
</body>
</html>
